name: Build Deploy

# Trigger deployment only on push to master branch
on:
    push:
        branches: [main]

jobs:
    deploy:
        name: Deploy to EC2 on master branch push
        runs-on: ubuntu-latest

        steps:
          - name: Deploy in EC2
            uses: appleboy/ssh-action@master

            env:
              DATABASE_URL: ${{ secrets.DATABASE_URL }}
            with:
              host: ${{secrets.HOST_DNS}}
              username: ${{secrets.USERNAME}}
              key: ${{secrets.EC2_SSH_KEY}}
              envs: DATABASE_URL
              script:  |
              `
                  cd /home/ec2-user/TakeNotes &&
                  git checkout main &&
                  git fetch --all &&
                  git reset --hard origin/main &&
                  git pull origin main &&
                  docker build -t takenotes . &&
                  docker run --name takenotes -d -p 3000:3000 -e DATABASE_URL="${DATABASE_URL}" takenotes:latest`